import { asyncTryCatch } from "../utils/asyncTryCatch.js";
import csv from 'csv-parser';
import { Readable } from 'stream';
import { sendErrorResponse } from "../utils/sendError.js";
import { sendSuccessResponse } from "../utils/sendSuccess.js";

const  vulnerabilityController = {};

const _parseCsvFile = (file) => {
    return new Promise((resolve, reject) => {
      const results = [];
      const stream = Readable.from(file.buffer);
  
      stream
        .pipe(csv({
          mapHeaders: ({ header }) => header.trim()
        }))
        .on("data", (row) => {
          results.push(row);
        })
        .on("error", (err) => {
          reject(sendErrorResponse(500, err.message));
        })
        .on("end", () => {
          resolve(sendSuccessResponse(200, 'CSV file parsed successfully', results));
        });
    });
};
  

vulnerabilityController.parseCsvVulnerability = asyncTryCatch(async (req, res)=>{
    if (!req.file) {
        return res.status(400).send(sendErrorResponse(400, "No Csv file uploaded"));
    }

    const data = await _parseCsvFile(req.file);
    return res.status(data.status).send(data);

});

export default vulnerabilityController;