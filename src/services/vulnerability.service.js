import { sendSuccessResponse } from "../utils/sendSuccess.js";
import { validateVulnerabilityList } from "../validations/vulnerability.validation.js";
import { formatZodErrorsArray } from "../utils/formatZodError.js";
import { sendErrorResponse } from "../utils/sendError.js";

const vulnerabilityService = {};

vulnerabilityService.addVulnerability = async (data)    => {
    const validatedData = validateVulnerabilityList.safeParse(data);
    if (!validatedData.success) {
        return sendErrorResponse(400, formatZodErrorsArray(validatedData.error));
    }
    const vulnerabilities = validatedData.data;

    const unique_vulnerability = new Set();
    const unique_vulnerability_list = [];

    vulnerabilities.forEach( vulnerability => {
        if(unique_vulnerability.has(vulnerability.cve_id)) {
            return;
        }
        unique_vulnerability.add(vulnerability.cve_id);
        unique_vulnerability_list.push(vulnerability);
    })
    
    return sendSuccessResponse(200, 'Vulnerability added successfully', unique_vulnerability_list);
}

export default vulnerabilityService;