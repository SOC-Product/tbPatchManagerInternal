import { sendSuccessResponse } from "../utils/sendSuccess.js";
import { validate_linux_vulnerability } from "../validations/vulnerability.validation.js";
import { 
  _bulk_add_linux_vulnerability,
  _bulk_linux_vulnerability_mapping,
  _get_unique_vulnerability,
  _validate_lixux_vulnerability 
} from "../helpers/vulnerability.helper.js";
import { formatZodErrorsArray } from "../utils/formatZodError.js";
import { sendErrorResponse } from "../utils/sendError.js";
import { query } from '../config/database.js';
import { SCRIPT } from '../constants/script.js';

const vulnerabilityService = {};


vulnerabilityService.addLinuxVulnerability = async (data) => {
  const validatedData = validate_linux_vulnerability.safeParse(data);
  if (!validatedData.success) {
    return sendErrorResponse(400, formatZodErrorsArray(validatedData.error));
  }
  const vulnerabilities = validatedData.data;

  const unique_vulnerability_list = _get_unique_vulnerability(vulnerabilities);

  try {
    await query(SCRIPT.BEGIN_TRANSACTION);

    const host_data = await _validate_lixux_vulnerability(vulnerabilities);

    await _bulk_add_linux_vulnerability(unique_vulnerability_list)

    await _bulk_linux_vulnerability_mapping(host_data);

    await query(SCRIPT.COMMIT);
    return sendSuccessResponse(200, 'Linux vulnerability added successfully');
  } catch (error) {
    await query(SCRIPT.ROLLBACK);
    return sendErrorResponse(499, error)
  }
}

export default vulnerabilityService;